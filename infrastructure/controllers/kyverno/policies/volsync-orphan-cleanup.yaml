---
apiVersion: kyverno.io/v2
kind: ClusterCleanupPolicy
metadata:
  name: volsync-orphan-cleanup
  annotations:
    argocd.argoproj.io/sync-wave: "4"
    policies.kyverno.io/title: VolSync Orphan Resource Cleanup
    policies.kyverno.io/description: >-
      Cleans up orphaned VolSync backup resources when the backup label is removed
      from the corresponding PVC or the PVC no longer exists. Runs every 15 minutes.
      Targets resources generated by the volsync-pvc-backup-restore policy
      (identified by app.kubernetes.io/managed-by=kyverno and volsync.backup/pvc labels).
spec:
  schedule: "*/15 * * * *"
  match:
    any:
      - resources:
          kinds:
            - ReplicationSource
            - ReplicationDestination
          selector:
            matchExpressions:
              - key: app.kubernetes.io/managed-by
                operator: In
                values: ["kyverno"]
              - key: volsync.backup/pvc
                operator: Exists
      - resources:
          kinds:
            - Secret
          selector:
            matchExpressions:
              - key: app.kubernetes.io/managed-by
                operator: In
                values: ["kyverno"]
              - key: volsync.backup/pvc
                operator: Exists
  exclude:
    any:
      - resources:
          namespaces:
            - kube-system
            - volsync-system
            - kyverno
  context:
    - name: pvcName
      variable:
        jmesPath: 'target.metadata.labels."volsync.backup/pvc"'
    - name: pvcBackupLabel
      apiCall:
        urlPath: "/api/v1/namespaces/{{target.metadata.namespace}}/persistentvolumeclaims"
        jmesPath: "items[?metadata.name=='{{pvcName}}'].metadata.labels.backup | [0] || ''"
  conditions:
    all:
      - key: "{{ pvcBackupLabel }}"
        operator: NotIn
        values: ["hourly", "daily"]
